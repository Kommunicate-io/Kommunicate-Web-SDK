<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <title>Map + Advanced Marker + Place Autocomplete Element</title>
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <style>
            html,
            body {
                height: 100%;
                margin: 0;
            }
            .wrap {
                display: grid;
                grid-template-rows: auto 1fr auto;
                height: 100%;
            }
            header {
                padding: 10px 12px;
                border-bottom: 1px solid #e5e5e5;
            }
            #controls {
                display: flex;
                gap: 8px;
                align-items: center;
                flex-wrap: wrap;
            }
            #map {
                width: 100%;
                height: 100%;
            }
            .inputs {
                padding: 8px 12px;
                border-top: 1px solid #e5e5e5;
                font: 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
            }
            .inputs label {
                margin-right: 12px;
            }
            .inputs input {
                width: 140px;
            }
        </style>
    </head>
    <body>
        <div class="wrap">
            <header>
                <div id="controls">
                    <!-- Weâ€™ll insert the Place Autocomplete Element here via JS -->
                    <span id="autocomplete-slot"></span>
                    <button id="use-current">Use marker position</button>
                </div>
            </header>

            <div id="map"></div>

            <!-- Handy mirrors (optional) -->
            <div class="inputs">
                <label>Lat <input id="lat" type="text" readonly /></label>
                <label>Lng <input id="lng" type="text" readonly /></label>
                <label>Address <input id="addr" type="text" readonly style="width: 320px" /></label>
            </div>
        </div>

        <script>
            // Called by the async Maps JS loader below
            async function initMap() {
                // Load libraries (maps, marker, places)
                const { Map } = await google.maps.importLibrary('maps');
                const { AdvancedMarkerElement } = await google.maps.importLibrary('marker');
                await google.maps.importLibrary('places');

                // --- Basic map config (center can be anything you like) ---
                const start = { lat: 40.7324319, lng: -73.82480777777776 }; // Queens, NY
                const map = new Map(document.getElementById('map'), {
                    center: start,
                    zoom: 14,
                    mapId: 'AIzaSyCcC8PixPO1yzz35TnjWYIhQvCljTPSU7M', // <-- REQUIRED for AdvancedMarkerElement to work fully
                });

                // --- Advanced Marker (draggable) ---
                const marker = new AdvancedMarkerElement({
                    map,
                    position: start,
                    title: 'Drag Me',
                    gmpDraggable: true,
                });

                // Mirror fields for demo
                const $lat = document.getElementById('lat');
                const $lng = document.getElementById('lng');
                const $addr = document.getElementById('addr');

                function setMirror(latLng, addressText) {
                    $lat.value =
                        typeof latLng.lat === 'function'
                            ? latLng.lat().toFixed(6)
                            : Number(latLng.lat).toFixed(6);
                    $lng.value =
                        typeof latLng.lng === 'function'
                            ? latLng.lng().toFixed(6)
                            : Number(latLng.lng).toFixed(6);
                    if (addressText !== undefined) $addr.value = addressText || '';
                }

                // Initial mirror
                setMirror(marker.position);

                // Reverse geocode helper
                const geocoder = new google.maps.Geocoder();
                async function reverseGeocode(latLng) {
                    try {
                        const { results } = await geocoder.geocode({ location: latLng });
                        return results && results[0] ? results[0].formatted_address : '';
                    } catch {
                        return '';
                    }
                }

                // Update mirrors on drag end
                marker.addListener('dragend', async () => {
                    const pos = marker.position;
                    map.panTo(pos);
                    const addrText = await reverseGeocode(pos);
                    setMirror(pos, addrText);
                });

                // --- Place Autocomplete Element (new) ---
                // Creates a web component; it renders its own input field.
                const placeEl = new google.maps.places.PlaceAutocompleteElement({
                    // Optional: add location bias or restriction if you want
                    // locationBias: { north: ..., south: ..., east: ..., west: ... }
                });

                // Insert it into the header slot
                document.getElementById('autocomplete-slot').appendChild(placeEl);

                // When the user picks a suggestion:
                placeEl.addEventListener('gmp-select', async ({ placePrediction }) => {
                    const place = placePrediction.toPlace();
                    // Fetch the fields you need (address, location, etc.)
                    await place.fetchFields({
                        fields: [
                            'location',
                            'formattedAddress',
                            'displayName',
                            'addressComponents',
                        ],
                    });

                    if (place.location) {
                        const loc = place.location; // google.maps.LatLng
                        map.panTo(loc);
                        marker.position = loc; // AdvancedMarkerElement
                        const addressText =
                            place.formattedAddress || (place.displayName ? place.displayName : '');
                        setMirror(loc, addressText);
                    }
                });

                // Button: write current marker position into the address (reverse geocode)
                document.getElementById('use-current').addEventListener('click', async () => {
                    const addrText = await reverseGeocode(marker.position);
                    setMirror(marker.position, addrText);
                });
            }

            // Expose initMap for the loader callback
            window.initMap = initMap;
        </script>

        <!-- Maps JS loader. Replace YOUR_API_KEY. Keeping v=weekly is fine; you can pin if needed. -->
        <script
            async
            src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCcC8PixPO1yzz35TnjWYIhQvCljTPSU7M&v=weekly&callback=initMap"
        ></script>
    </body>
</html>
