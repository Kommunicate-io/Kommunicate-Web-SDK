<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Kommunicate Chat</title>
    <style>
      * { margin: 0; padding: 0; box-sizing: border-box; }
      body { font: 13px Helvetica, Arial; }
      form { background: #000; padding: 3px; position: fixed; bottom: 0; width: 100%; }
      form input { border: 0; padding: 10px; width: 90%; margin-right: .5%; }
      form button { width: 9%; background: rgb(85, 83, 183); color: white; border: none; padding: 10px; }
      #messages { list-style-type: none; margin: 0; padding: 0; }
      #messages li { padding: 5px 10px; }
      #messages li:nth-child(odd) { background: #eceff1; }
    </style>

    <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
    <script src="https://cdn.applozic.com/applozic/applozic.chat-5.1.min.js"></script>

    <script type="text/javascript">
      var socketConnected = false;

      var events = {
        'onMessageReceived': function(resp) {
          //will trigger when you will receive a new msg
          console.log(resp);
          $('#messages').append($('<li>').text(resp.message.from + ": " + resp.message.message));
        },
        'onMessageSent': function(resp) {
          console.log(resp);
          //will trigger when you will send a message 
          $('#messages').append($('<li>').text("you: " + resp.message.message));
        },
        'onConnectFailed': function(resp) {},
        'onConnect': function(resp) {
          socketConnected = true;
          if (groupId) {
            window.Applozic.ALSocket.subscibeToTypingChannel(groupId);
          }
        },
        'onMessageDelivered': function(resp) {},
        'onMessageRead': function(resp) {
          // will trigger when another user chat is open and you send a msg
        },
        'onMessageDeleted': function(resp) {},
        'onConversationDeleted': function(resp) {},
        'onUserConnect': function(resp) {},
        'onUserDisconnect': function(resp) {},
        'onConversationReadFromOtherSource': function(resp) {},
        'onConversationRead': function(resp) {
          //will trigger when another user will open your chat thread
        },
        'onMessageSentUpdate': function(resp) {},
        'onUserBlocked': function(resp) {},
        'onUserUnblocked': function(resp) {},
        'onUserActivated': function(resp) {},
        'onUserDeactivated': function(resp) {},
        'connectToSocket': function(resp) {},
        'onMessage': function(resp) { 
          //console.log(resp); //Will trigger for every   message 
        },
        'onTypingStatus': function(resp) {
          var typingData = resp.body.split(",");
          if (typingData[2] == "1") {
            document.getElementById("typing-status").innerHTML = (typingData[1] + " is typing...");
          } else {
            document.getElementById("typing-status").innerHtml = "";
          }
        }
    };
    
    var APP_ID = "kommunicate-support";

    </script>

    <script>

    var groupId;
    var userId = 'debug4'; //Todo: replace with your userId and password
    var password = 'debug4';
    var botId = 'kommunicate-support-bot';

    $(function () {
      Applozic.ALApiService.login(
      {
        data: {
          baseUrl: 'https://chat.kommunicate.io',
          alUser:
          {
            userId: userId, //Logged in user's id, a unique identifier for user
            password: password,//Enter password here for the userId passed above, read this if you want to add additional security by verifying password from your server https://www.applozic.com/docs/configuration.html#access-token-url
            imageLink: '', //User's profile picture url
            email: '', //optional
            contactNumber: '', //optional, pass with internationl code eg: +13109097458
            appVersionCode: 108,
            applicationId: APP_ID, 
          }
        },
        success: function(response) {
          console.log(response);
          var data = {};
          data.token = response.token;
          data.deviceKey = response.deviceKey;
          data.websocketUrl = response.websocketUrl;
          //Get your APP_ID from https://dashboard.kommunicate.io
          //This method initializes socket connection 
          window.Applozic.ALSocket.init(APP_ID, data, events);
          Applozic.ALApiService.createGroup({
              data:
                  {
                      group: {
                          "groupName": "Support",
                          "users": [{ 'userId': botId, 'groupRole': 2},
                                    { 'userId': userId, 'groupRole': 1 }],
                          "type": 10,      //(required) 1:private, 2:public, 5:broadcast, 7:GroupofTwo, 10:Support Chat
                          "metadata":{
                            "CONVERSATION_ASSIGNEE":"kommunicate-support-bot",
                            "KM_CONVERSATION_TITLE":"Support",
                            "CREATE_GROUP_MESSAGE":"","REMOVE_MEMBER_MESSAGE":"","ADD_MEMBER_MESSAGE":"",
                            "JOIN_MEMBER_MESSAGE":"","GROUP_NAME_CHANGE_MESSAGE":"","GROUP_ICON_CHANGE_MESSAGE":"",
                            "GROUP_LEFT_MESSAGE":"","CONVERSATION_STATUS":0,"DELETED_GROUP_MESSAGE":"",
                            "GROUP_USER_ROLE_UPDATED_MESSAGE":"","GROUP_META_DATA_UPDATED_MESSAGE":"",
                            "HIDE":"true","SKIP_ROUTING":"false","KM_CHAT_CONTEXT":"{}"
                          }
                      }
                  }, success: function (response) { 
                    console.log("group created, groupId" + response.response.id);
                    console.log(response); 
                    groupId = response.response.id;

                    if (socketConnected) {
                      console.log("subscribing to typing event for groupId: " + groupId);
                      window.Applozic.ALSocket.subscibeToTypingChannel(groupId);
                    }
                  },
              error: function () { }
          });
          
        },
        error: function() {
        
        }
      }
    );

      $('form').submit(function(e){
        e.preventDefault(); // prevents page reloading
        console.log("send message");
        Applozic.ALApiService.sendMessage({
          data: {
              message: {
                  "type": 5,
                  "contentType": 0,
                  "message": $('#m').val(),
                  "groupId": String(groupId),
                  "metadata": {},
                  "key": "mpfj2",
                  "source": 1
              }
          },
          success: function (response) { console.log(response); },
          error: function () { }
      });

        $('#m').val('');
        return false;
      });
    
      
      //Typing indicator
      document.getElementById("m").addEventListener("keyup", function() {
        console.log("#sending typing event for userId: " + userId + ", groupId: " + groupId);
        window.Applozic.ALSocket.sendTypingStatus("1", "1", userId, groupId);
      }, false);

      //window.Applozic.ALSocket.unsubscibeToTypingChannel();

    });
  </script>

  </head>
  <body>
    <ul id="messages"></ul>
    <form action="">
      <input id="m" autocomplete="off" /><button>Send</button>
    </form>
    <span id="typing-status">Typing indicator</span>
  </body>
</html>